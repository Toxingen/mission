## 中断实验

### 问题

1. #### 中断的概念

   cpu在处理某一A事件时，发生事件B请求cpu立刻去处理（中断发生），此时cpu暂停A事件（中断响应）并去处理B事件（中断服务）后返回A事件（中断返回），整个的流程便叫做中断。

2. #### 为什么有中断

   总的来说，中断使得计算机（单片机）具有了顺序、并发处理事件与程序的能力。作用可归纳如下：

   * 实现分时操作 采用中断技术后,快速的CPU和慢速的外设可以各做各的事情。
   * 进行实时处理 在实时控制的过程中,CPU会根据当时的情况及时做出反应,进行实时控制。
   * 故障处理 系统在运行过程中往往会出现一些异常情况。
   * 响应快、电平和时钟触发中断、计数中断、定时中断、来自串口数据中断、睡眠中断唤醒模式中断。

   

3. #### 中断的处理流程

   * 中断响应的事前准备：

   　　中断优先级分组、抢占优先级、响应优先级配置（中断向量配置）。

   * CPU检查是否有中断/异常信号

    　　每次执行根据时钟信号检查是否有中断信号

   * 分析其中断向量设置

   * 保护当前程序现场

   * 判定中断的栈，执行中断事件的函数，处理中断

   * 中断处理完成，返回保护程序现场继续执行原程序

     

4. #### HAL库中中断的调用流程

   * 新建工程

     * 新建工程

     * 设置RCC

     * GPIO初始化

       设置l对应的引角GPIO基本参数，并对GPIO_EXIT的6种模式进行选择。

     * 设置NVIC

       使能中断，并设置相应和抢占优先级。 

     * 中断函数编写
     
       

###   实操问题与收获

* 拿到新板子时key引脚号并没有在pcb上标明，经过好一番折腾，拿到了例程并在里面找到了key的引角号。
* 使能key为中断时，SYS出现感叹号，查看原因发现是因为key的引脚PA0为SYSTEM WAKE-UP的默认引脚号。一开始想要去掉感叹号，于是考虑了复用引脚，但经过实测发现，感叹号情况下PA0还是可以作为中断引脚使用，具体原因尚不清楚。
* 编写函数时出现了很多小错误，包括函数定义、变量定义不规范，定义冲突等等。

## 串口通信实验

### 问题

1. #### 什么是通信协议？为什么要有通信协议？

   * 通信协议是指双方实体完成通信或服务所必须遵循的规则和约定。通过通信信道和设备互连起来的多个不同地理位置的数据通信系统，要使其能协同工作实现信息交换和资源共享，它们之间必须具有共同的语言。交流什么、怎样交流及何时交流，都必须遵循某种互相都能接受的规则。这个规则就是通信协议。
   * 通信协议本就是通信的规则，它使得构造不尽相同的通信系统之间能进行正常的通信，其之于通信系统就像语言之于人一样重要。

2. #### 解释重要概念：数据帧，校验位，波特率

   * 数据帧

     一种信息数据单位，包括帧头、数据部分、帧尾。

   * 校验位

     校验位分为偶校验位与奇校验位。即通过检测给定位数数据的二进制中1的个数是偶数还是奇数进行错误检测。

   * 波特率

     波特率容易与比特率混淆。它表示每秒钟传输了多少个码元，码元单位可以是以1比特或是2比特，在一般的情况下波特率与比特率相等。

     

3. #### 串口有哪几种中断？哪些事件可以触发串口中断

   * 见表格

   | 中断事件                                 | 事件标志  | 使能控制位 |
   | ---------------------------------------- | --------- | ---------- |
   | 发送数据寄存器为空                       | TXE       | TXEIE      |
   | CTS 标志                                 | CTS       | CTSIE      |
   | 发送完成                                 | TC        | TCIE       |
   | 准备好读取接收到的数据                   | RXNE      | RXNEIE     |
   | 检测到上溢错误                           | ORE       | RXNEIE     |
   | 检测到空闲线路                           | IDLE      | IDLEIE     |
   | 奇偶校验错误                             | PE        | PEIE       |
   | 断路标志                                 | LBD       | LBDIE      |
   | 多缓冲通信中的噪声标志、上溢错误和帧错误 | NF/ORE/FE | EIE        |

   

4. #### 串口通信的物理层，协议层

   * 在计算机科学里，大部分复杂的问题都可以通过分层来简化。如芯片被分为内核层和 片上外设；STM32 标准库则是在寄存器与用户代码之间的软件层。对于通讯协议，我们也 以分层的方式来理解，最基本的是把它分为物理层和协议层。物理层规定通讯系统中具有 机械、电子功能部分的特性，确保原始数据在物理媒体的传输。协议层主要规定通讯逻辑， 统一收发双方的数据打包、解包标准。简单来说物理层规定我们用嘴巴还是用肢体来交流， 协议层则规定我们用中文还是英文来交流。

   ### 实操问题与收获

   * 第一次配置好代码后，编译并没有报错，但进行收发时板子只能接收数据而不能回传数据。经过一系列折腾之后，发现是收发函数中Time_out 参数不能使用十进制数100来表示，将其更改为16进制0xffff后问题顺利解决。
   * 此次收发为定长，但实际上可以用中断实现不定长收发，但时间不允许的情况下便没有仔细去实现。
   * 时钟设置对异步通信不定长收发还是有影响。
